<!DOCTYPE html>
<html lang="si">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>à·€à·™à¶±à·à¶»à· â€” Sinhala Call Center Assistant</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Sinhala:wght@400;700&display=swap" rel="stylesheet">
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:#000;min-height:100vh;display:flex;align-items:center;justify-content:center;font-family:'Noto Sans Sinhala',sans-serif;padding:24px}
    .container{width:720px;max-width:95vw;background:transparent;display:flex;flex-direction:column;align-items:center;gap:18px}
    .circle-btn{width:320px;height:320px;border-radius:50%;background:#fff;border:0;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:2.2rem;font-weight:700;color:#000;transition:transform .15s,box-shadow .15s}
    .circle-btn:hover:not(:disabled){transform:scale(1.04);box-shadow:0 0 40px rgba(255,255,255,.25)}
    .circle-btn:disabled{opacity:.6;cursor:not-allowed}
    .meta{color:#aaa;text-align:center;font-size:.95rem}
    .message{color:#fff;margin-top:6px;min-height:38px;text-align:center}
    .message.success{color:#4ade80}
    .message.error{color:#f87171}
    .spinner{width:36px;height:36px;border-radius:50%;border:4px solid rgba(255,255,255,.2);border-top-color:#fff;animation:spin 1s linear infinite;margin-left:12px}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .row{display:flex;align-items:center;gap:12px}

    /* results panel */
    .results{width:100%;background:#111;border:1px solid #333;border-radius:12px;padding:20px;margin-top:12px;color:#e0e0e0;font-size:.92rem;line-height:1.6;display:none}
    .results.visible{display:block}
    .results h3{color:#fff;margin-bottom:10px;font-size:1.1rem}
    .step{margin-bottom:16px;padding:12px;background:#1a1a1a;border-radius:8px;border-left:3px solid #555}
    .step.ok{border-left-color:#4ade80}
    .step.warn{border-left-color:#facc15}
    .step.err{border-left-color:#f87171}
    .step-title{font-weight:700;color:#fff;margin-bottom:4px}
    .label{color:#888;font-size:.84rem}
    .val{color:#fff;word-break:break-all}
    .val.si{font-family:'Noto Sans Sinhala',sans-serif}
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- React + Babel via CDN (no build step) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const {useState} = React;

    /* â”€â”€ tiny helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    const Val = ({label, children, si}) => (
      <div style={{marginBottom:4}}>
        <span className="label">{label}: </span>
        <span className={`val${si ? ' si' : ''}`}>{children || 'â€”'}</span>
      </div>
    );

    /* â”€â”€ app â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function App(){
      const [loading, setLoading]   = useState(false);
      const [status, setStatus]     = useState(null);
      const [results, setResults]   = useState(null);
      const [showFeedback, setShowFeedback] = useState(false);

      async function triggerStart(){
        setLoading(true);
        setResults(null);
        setStatus({type:'info', text:'à¶šà·Šâ€à¶»à·’à¶ºà·à·€à¶½à·’à¶º à¶†à¶»à¶¸à·Šà¶· à·€à·™à¶¸à·’à¶±à·Š à¶´à·€à¶­à·“ â€” greeting + recording...'});

        try{
          const res = await fetch('/start-audio',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({connection_number:null, customer_nic:null, customer_name:null})
          });

          const data = await res.json();

          if(res.ok && data.status === 'success'){
            setStatus({type:'success', text:'à¶šà·Šâ€à¶»à·’à¶ºà·à·€à¶½à·’à¶º à·ƒà·à¶»à·Šà¶®à¶šà¶ºà·’'});
            setResults(data.workflow_results);
          } else {
            setStatus({type:'error', text:`à¶¯à·à·‚à¶º: ${data.message || 'Unknown error'}`});
          }
        }catch(err){
          console.error(err);
          setStatus({type:'error', text:`à¶¯à·à·‚à¶º: ${err.message}`});
        }finally{
          setLoading(false);
        }
      }

      const r = results;

      return (
        <div className="container">

          {/* â”€â”€ button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
          <div style={{display:'flex',flexDirection:'column',alignItems:'center'}}>
            <button className="circle-btn" onClick={triggerStart} disabled={loading} aria-label="Start conversation">
              à·€à·™à¶±à·à¶»à·
            </button>
            <div className="meta" style={{marginTop:10}}>Click to start the call flow â€” plays greeting, records, extracts, verifies.</div>
          </div>

          {/* â”€â”€ feedback button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
          <a href="/static/feedback.html" style={{marginTop:10,color:'#888',textDecoration:'none',fontSize:'0.9rem',border:'1px solid #333',padding:'8px 16px',borderRadius:'4px',transition:'all 0.2s'}}>
            ğŸ“Š à¶´à·Šâ€à¶»à¶­à·’à¶´à·à·‚à¶« à¶‰à·€à·’à¶§ à¶šà¶»à¶±à·Šà¶±
          </a>

          {/* â”€â”€ status row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
          <div className="row">
            {loading && <div className="spinner" aria-hidden="true"></div>}
            {status && <div className={`message ${status.type==='success'?'success':status.type==='error'?'error':''}`}>{status.text}</div>}
          </div>

          {/* â”€â”€ results panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
          {r && (
            <div className="results visible">
              <h3>Workflow Results</h3>

              {/* step 1 */}
              <div className={`step ${r.step_1?.transcription ? 'ok' : 'warn'}`}>
                <div className="step-title">Step 1 â€” Greeting &amp; Capture (45 s)</div>
                <Val label="Greeting" si>{r.step_1?.greeting}</Val>
                <Val label="Transcription" si>{r.step_1?.transcription}</Val>
              </div>

              {/* step 2 */}
              <div className={`step ${r.step_2?.transcription ? 'ok' : 'warn'}`}>
                <div className="step-title">Step 2 â€” Name / NIC / Connection Capture (30 s)</div>
                <Val label="Prompt" si>{r.step_2?.prompt}</Val>
                <Val label="Transcription" si>{r.step_2?.transcription}</Val>
              </div>

              {/* extraction */}
              <div className={`step ${r.extraction?.name && r.extraction?.nic ? 'ok' : 'warn'}`}>
                <div className="step-title">Step 3 â€” Regex Extraction</div>
                <Val label="Name">{r.extraction?.name}</Val>
                <Val label="NIC">{r.extraction?.nic}</Val>
                <Val label="Connection No.">{r.extraction?.connection_number}</Val>
              </div>

              {/* verification */}
              <div className={`step ${r.verification?.is_valid ? 'ok' : 'err'}`}>
                <div className="step-title">Step 4 â€” Database Verification</div>
                <Val label="Verified">{r.verification?.is_valid ? 'Yes' : 'No'}</Val>
                {r.verification?.customer_data && <Val label="Customer Data">{r.verification.customer_data}</Val>}
                {r.verification?.error && <Val label="Error">{r.verification.error}</Val>}
              </div>

              {/* LLM */}
              <div className={`step ${r.llm_response && !r.llm_response?.error ? 'ok' : 'warn'}`}>
                <div className="step-title">Step 5 â€” LLM (WORKFLOW_API) Response</div>
                <Val label="Response">{typeof r.llm_response === 'object' ? JSON.stringify(r.llm_response) : r.llm_response}</Val>
              </div>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
